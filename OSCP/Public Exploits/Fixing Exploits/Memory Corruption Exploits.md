
#### Buffer Overflows

A buffer overflow occurs when  the users provided content goes beyond the stack limit and over runs into adjacent memory.

This can occur in different parts of memory such as the heap or the stack. 

The `Heap` is dynamically managed and normally stores chucks of globally accessible data. The `Stack` stores local functions data and its size is generally fixed.

The `stack` often contains local variables like integers or buffers. The stack makes room for the `exact space` needed by a` buffer` along with `function parameters` and `the return address`.

`The return address` is a memory address that stores the next function to be executed once the one running has completed.

`If the users input is bigger than the destination buffers space if could overwrite the return address`.

When a function ends it executes the `ret` instruction - which loads the return address inside the `EIP/RIP` instruction pointer responsible for keeping track of current code instructions.

if an attack has control over the return address - they may eventually control program flow - and execute arbitrary code on the system.

#### Practice

Once the correct offset is found - an attack will overwrite the return address with a valid mapped memory address containing shellcode that gives the attacker full control of the target machine.

An attack may fill the buffer up with `A` until it can see that the return is overwritten with `A`. which the attacker will then determine the offset.

A typical attack involves overwriting the return address with a `JMP ESP` instruction which instructs a program to jump to the stack and execute shell code that has been injected right after the beginning of the payload.

`JMP` - jump to stack
`ESP` - stack top is pointed to by the ESP register

```
The general flow of a standard stack-based buffer overflow is fairly straightforward. The exploit will:

1.Create a large buffer to trigger the overflow.

2.Take control of EIP by overwriting a return address on the stack, padding the large buffer with an appropriate offset.

3.Include a chosen payload in the buffer prepended by an optional NOP sled.

4.Choose a correct return address instruction such as JMP ESP (or a different register) to redirect the execution flow to the payload
```

The Best way to develop and test buffer overflow exploits is the clone the environment locally in a virtual machine and use a debugger on the vulnerable software to obtain the memory address of the return address instruction.

#### Entry Points

`strcpy(buffer, data)` - in C does not check that the space allotted for the buffer is enough for the data - hence we can trigger an overflow.


#### Mitigations

`ASLR` 
`executable space protection`


#### Bad Characters

Bad characters are ASCII or UNICODE characters that break the application when included in the payload because they might be interpreted as control characters. For example, the null-byte "\x00" is often interpreted as a string terminator and, if inserted in the payload, could prematurely truncate the attack buffer.